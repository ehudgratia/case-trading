name: deploy-go-app

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Debug GitHub OIDC Token Claims
      id: debug-oidc
      run: |
        echo "Requesting OIDC token with default audience..."
        TOKEN_RESPONSE=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com")

        echo "Full response (partial): ${TOKEN_RESPONSE:0:200}..."

        # Extract token value
        TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r .value 2>/dev/null || echo "null")

        if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
          echo "Error: No token received. Check permissions: id-token: write"
          echo "Response was: $TOKEN_RESPONSE"
          exit 1
        fi

        echo "JWT Token (partial): ${TOKEN:0:50}..."

        echo "Decoding payload claims..."
        # Decode payload (base64url decode bagian tengah JWT)
        PAYLOAD=$(echo "$TOKEN" | cut -d '.' -f 2 | base64 -d 2>/dev/null | jq . || echo "Decode failed")

        echo "Decoded Claims:"
        echo "$PAYLOAD"
  
  # deploy:
  #   name: Deploy to VPS
  #   needs: docker
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: SSH Deploy
  #       uses: appleboy/ssh-action@v1.0.3
  #       with:
  #         host: ${{ secrets.SERVER_HOST }}
  #         username: ${{ secrets.SERVER_USER }}
  #         key: ${{ secrets.SERVER_SSH_KEY }}
  #         script: |
  #           cd ./case-trading
  #           docker compose pull
  #           docker compose up -d --force-recreate